<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LYRN Asset Shop (Module)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    /* [ ... CORE VARIABLES MATCHING LYRN OS ... ] */
    :root {
      --bg-core: #050505;
      --bg-panel: #0a0a0a;
      --bg-input: #050505;
      --brand-purple: #7c5cff;
      --brand-purple-dim: rgba(124, 92, 255, 0.1);
      --text-head: #ffffff;
      --text-body: #b0b0b0;
      --text-dim: #666666;
      --border-color: #222222;
      --input-focus-bg: #111111;
      --success-color: #10B981;
      --error-color: #EF4444;

      --btn-text: #e0e0e0;
      --btn-border: #444444;
      --btn-bg: rgba(255,255,255,0.03);

      /* TYPOGRAPHY */
      --font-size-base: 12px;
    }

    body[data-theme="light"] {
        --bg-core: #eef0f4;
        --bg-panel: #ffffff;
        --bg-input: #ffffff;
        --brand-purple: #6a4ce0;
        --brand-purple-dim: rgba(106, 76, 224, 0.1);
        --text-head: #111111;
        --text-body: #333333;
        --text-dim: #555555;
        --border-color: #d1d5db;
        --input-focus-bg: #f9fafb;
        --btn-text: #333;
        --btn-border: #ccc;
        --btn-bg: rgba(0,0,0,0.03);
    }

    * { box-sizing: border-box; }

    /* --- SCROLLBARS --- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-purple); }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-core); color: var(--text-body);
      font-family: 'Inter', system-ui, sans-serif;
      height: 100vh; width: 100vw; overflow: hidden;
      font-size: var(--font-size-base);
    }

    h1, h2, h3, h4 { font-family: 'JetBrains Mono', monospace; color: var(--text-head); margin: 0; }

    /* UI ELEMENTS */
    button {
      font-family: 'JetBrains Mono', monospace; 
      font-size: calc(var(--font-size-base) - 1px); 
      background: var(--btn-bg);
      border: 1px solid var(--btn-border); color: var(--btn-text); padding: 8px 16px;
      cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.2s ease; border-radius: 4px;
      white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:hover { border-color: var(--brand-purple); color: var(--brand-purple); }
    button.btn-primary { background: var(--brand-purple); color: #ffffff; border-color: var(--brand-purple); font-weight: 600; }
    button.btn-primary:hover { background: #6a4ce0; }
    
    .btn-square { width: 32px; height: 32px; padding: 0; font-size: calc(var(--font-size-base) + 4px); }

    /* LAYOUT */
    .app-wrapper {
      background: var(--bg-core);
      height: 100vh; width: 100%;
      display: flex; flex-direction: column; position: relative;
    }

    header {
      border-bottom: 1px solid var(--border-color); padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
      background: var(--bg-panel); flex-shrink: 0;
    }

    .meta-label { font-family: 'JetBrains Mono'; font-size: calc(var(--font-size-base) - 2px); color: var(--brand-purple); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; display: block; }
    .panel-title { font-size: calc(var(--font-size-base) + 2px); font-weight: 600; }

    /* CONTENT AREA */
    .content-area { flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; }

    .shop-section { margin-bottom: 30px; }
    .section-header { 
        font-family: 'JetBrains Mono'; color: var(--text-dim); font-size: calc(var(--font-size-base) - 1px); 
        text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px; margin-bottom: 12px;
    }

    .asset-row {
        display: flex; align-items: center; padding: 12px;
        background: var(--bg-panel); border: 1px solid var(--border-color);
        border-radius: 6px; margin-bottom: 8px; transition: all 0.2s;
        cursor: default;
    }
    .asset-row:hover { border-color: var(--brand-purple-dim); }
    .asset-row.selected { border-color: var(--brand-purple); background: var(--brand-purple-dim); }

    .asset-check {
        margin-right: 15px; display: none; /* Hidden by default */
        width: 18px; height: 18px; accent-color: var(--brand-purple);
        cursor: pointer;
    }
    .asset-check.visible { display: block; animation: fadeIn 0.2s ease-out; }
    
    @keyframes fadeIn { from { opacity:0; transform: scale(0.8); } to { opacity:1; transform: scale(1); } }

    .asset-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    .asset-name { color: var(--text-head); font-weight: 600; font-size: var(--font-size-base); }
    .asset-desc { color: var(--text-dim); font-size: calc(var(--font-size-base) - 1px); font-family: 'JetBrains Mono'; }
    .asset-path { color: var(--brand-purple); opacity: 0.6; font-size: 10px; font-family: 'JetBrains Mono'; margin-top: 2px; }

    /* FOOTER */
    .footer-bar { 
        padding: 12px 16px; border-top: 1px solid var(--border-color); 
        display: flex; justify-content: flex-end; align-items: center; gap: 15px;
        background: var(--bg-panel); flex-shrink: 0;
    }
    .status-text { font-family: 'JetBrains Mono'; color: var(--text-dim); font-size: calc(var(--font-size-base) - 1px); margin-right: auto; }

    /* TOAST */
    #toast {
        position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
        background: var(--bg-panel); border: 1px solid var(--brand-purple);
        color: var(--text-head); padding: 10px 20px; border-radius: 4px;
        font-family: 'JetBrains Mono', monospace; font-size: var(--font-size-base);
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 11000;
    }
    #toast.show { opacity: 1; }

    .download-mode-active .asset-row { cursor: pointer; }
    .download-mode-active .asset-row:hover { border-color: var(--brand-purple); }

  </style>
</head>
<body>

  <div class="app-wrapper">
    <header>
        <div>
            <div class="meta-label">LYRN SYSTEM MODULE</div>
            <h1 class="panel-title">Asset Shop</h1>
        </div>
        <div class="btn-group">
            <button class="btn-icon btn-square" onclick="alert('Asset Shop v1.1\nBatch download system components.')" title="Help">?</button>
        </div>
    </header>

    <div class="content-area" id="asset-list-container">
        </div>

    <div class="footer-bar">
         <span class="status-text" id="status-label">READY</span>
         <button id="main-action-btn" class="btn-primary" onclick="handleActionClick()">Download Assets</button>
    </div>
  </div>

  <div id="toast">Operation Successful</div>

  <script>
    /* =========================================
       CONFIG: AVAILABLE ASSETS
       ========================================= */
    const DOWNLOAD_ITEMS = {
        core: [
            { name: "LYRN Dashboard", path: "../dashboard.html", desc: "Main OS container and window manager." }
        ],
        modules: [
            { name: "Snapshot Builder", path: "Snapshot Builder.html", desc: "RWI prompt engineering tool." },
            { name: "Job Manager", path: "Job Manager.html", desc: "Task automation and scheduling system." },
            { name: "Asset Shop", path: "Asset Shop.html", desc: "Module for downloading system components." }
        ],
        extras: []
    };

    /* =========================================
       STATE
       ========================================= */
    let STATE = {
        downloadMode: false,
        selectedPaths: new Set()
    };

    /* =========================================
       INIT
       ========================================= */
    document.addEventListener('DOMContentLoaded', () => {
        renderShop();
        
        // Theme Sync Listener
        window.addEventListener('message', (event) => {
            if (event.data.type === 'THEME_CHANGE') {
                document.body.setAttribute('data-theme', event.data.theme);
            }
            if (event.data.type === 'FONT_CHANGE') {
                document.documentElement.style.setProperty('--font-size-base', event.data.fontSize + 'px');
            }
        });
    });

    /* =========================================
       RENDERING
       ========================================= */
    function renderShop() {
        const container = document.getElementById('asset-list-container');
        container.innerHTML = '';

        // Helper to render a category
        const renderCategory = (key, title) => {
            const items = DOWNLOAD_ITEMS[key];
            if (!items || items.length === 0) return;

            const section = document.createElement('div');
            section.className = 'shop-section';
            
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = title;
            section.appendChild(header);

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'asset-row';
                row.dataset.path = item.path;
                row.onclick = () => toggleSelection(item.path, row);

                const check = document.createElement('input');
                check.type = 'checkbox';
                check.className = 'asset-check';
                check.checked = STATE.selectedPaths.has(item.path);
                
                // Show checkbox if mode is active
                if (STATE.downloadMode) check.classList.add('visible');

                const info = document.createElement('div');
                info.className = 'asset-info';
                info.innerHTML = `
                    <span class="asset-name">${item.name}</span>
                    <span class="asset-desc">${item.desc}</span>
                    <span class="asset-path">${item.path}</span>
                `;

                row.appendChild(check);
                row.appendChild(info);
                section.appendChild(row);
            });

            container.appendChild(section);
        };

        renderCategory('core', 'Core System');
        renderCategory('modules', 'Modules');
        renderCategory('extras', 'Extras');
    }

    /* =========================================
       INTERACTION
       ========================================= */
    function handleActionClick() {
        const btn = document.getElementById('main-action-btn');
        const status = document.getElementById('status-label');

        // PHASE 1: ENTER SELECT MODE
        if (!STATE.downloadMode) {
            STATE.downloadMode = true;
            document.body.classList.add('download-mode-active');
            
            // Show checkboxes
            document.querySelectorAll('.asset-check').forEach(c => c.classList.add('visible'));
            
            btn.innerText = "Confirm Download";
            btn.classList.add('btn-confirm');
            status.innerText = "SELECT ASSETS";
            showToast("Select items to download");
        } 
        // PHASE 2: EXECUTE DOWNLOAD
        else {
            const count = STATE.selectedPaths.size;
            if (count === 0) {
                showToast("No assets selected", true);
                return;
            }
            executeDownload();
        }
    }

    function toggleSelection(path, rowElement) {
        if (!STATE.downloadMode) return;

        const check = rowElement.querySelector('.asset-check');
        
        if (STATE.selectedPaths.has(path)) {
            STATE.selectedPaths.delete(path);
            rowElement.classList.remove('selected');
            check.checked = false;
        } else {
            STATE.selectedPaths.add(path);
            rowElement.classList.add('selected');
            check.checked = true;
        }

        updateStatus();
    }

    function updateStatus() {
        const count = STATE.selectedPaths.size;
        const btn = document.getElementById('main-action-btn');
        const status = document.getElementById('status-label');
        
        if (count === 0) {
            btn.innerText = "Confirm Download";
            status.innerText = "SELECT ASSETS";
        } else {
            btn.innerText = `Download (${count})`;
            status.innerText = `${count} SELECTED`;
        }
    }

    /* =========================================
       DOWNLOAD LOGIC
       ========================================= */
    async function executeDownload() {
        const btn = document.getElementById('main-action-btn');
        const originalText = btn.innerText;
        btn.innerText = "Processing...";
        btn.disabled = true;

        const paths = Array.from(STATE.selectedPaths);

        try {
            // Loop through all selected paths and download sequentially
            for (let i = 0; i < paths.length; i++) {
                await downloadSingleFile(paths[i]);
                
                // Add a small delay between downloads to ensure browser registers them
                // and doesn't flag them as spam popups immediately
                if (i < paths.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            showToast("Downloads Started");
            resetState();
        } catch (err) {
            console.error(err);
            showToast("Download Failed", true);
        } finally {
            btn.innerText = "Download Assets"; // Reset to initial
            btn.disabled = false;
        }
    }

    function downloadSingleFile(path) {
        const link = document.createElement('a');
        link.href = path;
        // Extract filename from path
        const filename = path.split('/').pop();
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        // Return a small resolved promise just to keep async flow consistent
        return Promise.resolve();
    }

    function resetState() {
        STATE.downloadMode = false;
        STATE.selectedPaths.clear();
        document.body.classList.remove('download-mode-active');
        document.querySelectorAll('.asset-check').forEach(c => {
            c.checked = false; 
            c.classList.remove('visible');
        });
        document.querySelectorAll('.asset-row').forEach(r => r.classList.remove('selected'));
        
        const btn = document.getElementById('main-action-btn');
        btn.innerText = "Download Assets";
        document.getElementById('status-label').innerText = "READY";
    }

    function showToast(msg, error=false) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.borderColor = error ? 'var(--error-color)' : 'var(--brand-purple)';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>