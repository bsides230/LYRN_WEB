<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LYRN Dashboard v0.38</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />

    <style>
        /* =========================================
           1. CORE VARIABLES & THEME
           ========================================= */
        :root {
            /* DARK MODE DEFAULTS */
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --brand-purple: #7c5cff;
            --brand-purple-dim: rgba(124, 92, 255, 0.1);
            --brand-purple-glow: rgba(124, 92, 255, 0.4);
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --border-color: #222222;
            
            /* DOCK TOKENS */
            --dock-bg: rgba(10, 10, 10, 0.85);
            --dock-border: rgba(255, 255, 255, 0.1);
            --dock-blur: 20px;

            /* TYPOGRAPHY SCALE */
            --font-size-base: 12px;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --bg-panel: #ffffff;
            --brand-purple: #6a4ce0;
            --brand-purple-dim: rgba(106, 76, 224, 0.1);
            --brand-purple-glow: rgba(106, 76, 224, 0.3);
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
            --dock-bg: rgba(255, 255, 255, 0.85);
            --dock-border: rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0; width: 100vw; 
            min-height: 100vh; overflow: hidden; 
            background-color: var(--bg-core);
            font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-body);
            transition: background-color 0.5s ease;
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(124, 92, 255, 0.03) 10px, rgba(124, 92, 255, 0.03) 11px),
                radial-gradient(circle at 50% 0%, rgba(124, 92, 255, 0.15) 0%, transparent 60%);
            background-size: auto, 100% 100%;
            background-attachment: fixed;
            font-size: var(--font-size-base);
        }
        
        body.no-select * {
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        /* =========================================
           1.5 TOP SYSTEM BAR (Desktop & Tablet)
           ========================================= */
        #top-system-bar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 32px;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            z-index: 10000;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            user-select: none;
        }

        .bar-section { display: flex; align-items: center; gap: 15px; }

        .system-clock {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: var(--text-head);
            letter-spacing: 0.05em;
        }

        .bar-btn {
            background: transparent; border: none; color: var(--text-dim);
            cursor: pointer; font-family: 'JetBrains Mono'; font-size: 14px;
            padding: 4px; display: flex; align-items: center; justify-content: center;
            transition: color 0.2s;
        }
        .bar-btn:hover { color: var(--text-head); }
        .bar-btn.close-iframe-btn { color: #ff4444; margin-left: 10px; }
        .bar-btn.close-iframe-btn:hover { background: rgba(255, 68, 68, 0.1); border-radius: 4px; }
        
        #btn-close-iframe { display: none; }

        /* =========================================
           WELCOME MODAL
           ========================================= */
        #welcome-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            z-index: 99999;
            display: none; /* Toggled via JS */
            align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .welcome-modal {
            width: 420px; max-width: 90%;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-top: 1px solid var(--brand-purple);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px var(--brand-purple-dim);
            border-radius: 12px;
            padding: 24px;
            position: relative;
            display: flex; flex-direction: column; gap: 16px;
        }

        .welcome-close-x {
            position: absolute; top: 12px; right: 12px;
            background: transparent; border: none; color: var(--text-dim);
            cursor: pointer; padding: 4px; font-size: 16px;
        }
        .welcome-close-x:hover { color: var(--text-head); }

        .welcome-title {
            font-family: 'JetBrains Mono'; color: var(--text-head);
            font-size: 16px; margin: 0; letter-spacing: -0.5px;
            display: flex; align-items: center; gap: 8px;
        }

        .welcome-text { font-size: 13px; line-height: 1.5; color: var(--text-body); margin: 0; }
        .welcome-text strong { color: var(--brand-purple); }
        
        .welcome-feature {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            padding: 12px; border-radius: 8px; font-size: 12px;
            display: flex; align-items: flex-start; gap: 10px;
        }
        .welcome-icon { font-size: 16px; line-height: 1; }

        .welcome-footer {
            margin-top: 10px; padding-top: 15px; border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .welcome-checkbox {
            display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-dim); cursor: pointer;
        }
        .welcome-btn {
            background: var(--brand-purple); color: white; border: none;
            padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 500;
            cursor: pointer; transition: opacity 0.2s;
        }
        .welcome-btn:hover { opacity: 0.9; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* =========================================
           2. WINDOW SYSTEM
           ========================================= */
        #desktop-area { position: absolute; top: 32px; left: 0; right: 0; bottom: 0; z-index: 1; pointer-events: none; }
        
        .lyrn-window {
            pointer-events: auto;
            position: absolute; background: var(--bg-panel); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border-radius: 8px; width: 800px; height: 600px;
            min-width: 300px; min-height: 200px;
            transition: box-shadow 0.2s, opacity 0.2s, transform 0.2s;
            opacity: 0; transform: scale(0.95);
            animation: openWin 0.2s forwards ease-out;
        }
        
        .lyrn-window.maximized {
            transition: width 0.2s, height 0.2s, left 0.2s, top 0.2s;
        }

        @keyframes openWin { to { opacity: 1; transform: scale(1); } }

        .lyrn-window.active {
            border-color: var(--brand-purple);
            box-shadow: 0 25px 70px rgba(0,0,0,0.7), 0 0 15px var(--brand-purple-dim);
        }
        
        .lyrn-window.always-on-top {
            z-index: 9999 !important; 
            border: 1px solid var(--brand-purple);
            box-shadow: 0 0 0 1px var(--brand-purple), 0 25px 70px rgba(0,0,0,0.7);
        }

        .lyrn-window.locked .window-header { cursor: default; }
        .lyrn-window.locked .resize-handle { display: none; }

        .window-header {
            height: 36px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; padding: 0 8px 0 12px;
            cursor: grab; user-select: none; flex-shrink: 0;
        }
        .window-header:active { cursor: grabbing; }
        
        .window-title { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: calc(var(--font-size-base) - 1px); 
            text-transform: uppercase; color: var(--text-dim); 
        }
        
        .win-controls { display: flex; align-items: center; gap: 6px; }
        
        .win-btn {
            background: transparent; border: none; color: var(--text-dim);
            width: 24px; height: 24px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; 
            font-size: var(--font-size-base);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .win-btn:hover { background: var(--brand-purple-dim); color: var(--text-head); }
        
        .win-btn.is-locked { color: var(--brand-purple); background: var(--brand-purple-dim); transform: rotate(45deg); }
        .win-btn.is-active { background-color: var(--brand-purple); color: #ffffff; box-shadow: 0 2px 8px var(--brand-purple-glow); transform: scale(1.05); }
        .win-btn.close-btn:hover { background: rgba(255, 68, 68, 0.1); color: #ff4444; }

        .window-content { flex: 1; position: relative; background: var(--bg-core); overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; }
        
        .iframe-shield { position: absolute; top:0; left:0; width:100%; height:100%; z-index:10; display:none; }
        .lyrn-window.is-dragging .iframe-shield, 
        .lyrn-window.is-resizing .iframe-shield { display: block; }
        body.global-interaction .iframe-shield { display: block !important; }

        .resize-handle {
            position: absolute; bottom: 0; right: 0;
            z-index: 20; opacity: 0.5; transition: opacity 0.2s;
        }
        .resize-handle:hover { opacity: 1; background: var(--brand-purple-dim); }

        /* =========================================
           3. FLOATING DOCK & SETTINGS
           ========================================= */
        #floating-dock {
            position: fixed; z-index: 20000; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end; 
            width: 50px; height: 30px; 
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            transition: left 0.3s cubic-bezier(0.25, 1, 0.5, 1), top 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #floating-dock.is-dragging { transition: none !important; }

        #dock-content {
            position: absolute; bottom: 100%; margin-bottom: 12px;
            display: flex; gap: 8px; padding: 10px;
            background: var(--dock-bg); backdrop-filter: blur(var(--dock-blur));
            border: 1px solid var(--dock-border); border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            opacity: 1; pointer-events: auto;
            transform-origin: bottom center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 100; /* Content lower than handle */
        }
        
        /* --- Base Dock Button Styles --- */
        .dock-btn {
            background: transparent; border: none; 
            cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-head);
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .dock-btn:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.1); }
        .dock-btn:active { transform: scale(0.95); }

        #floating-dock.dock-collapsed:not(.pinned-open) #dock-content {
            opacity: 0; transform: translateY(10px) scale(0.8);
            pointer-events: none; visibility: hidden;
        }

        #dock-handle {
            width: 50px; height: 30px;
            background: var(--dock-bg); backdrop-filter: blur(var(--dock-blur));
            border: 1px solid var(--dock-border); border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            cursor: grab; 
            z-index: 200; /* Ensure handle is ON TOP of content stack for touch */
            position: relative; 
            touch-action: none; /* FIX: Prevents scroll/zoom interference on mobile */
        }
        #dock-handle:active { cursor: grabbing; transform: scale(0.95); }
        
        .handle-bar {
            width: 20px; height: 4px; background-color: #ffffff;
            border-radius: 2px; box-shadow: 0 0 6px var(--brand-purple), 0 0 12px var(--brand-purple);
            pointer-events: none; /* FIX: Ensures clicks pass through to the handle div */
        }

        /* --- SETTINGS POPUP --- */
        #settings-popup {
            position: absolute; bottom: 100%; right: 0; 
            margin-bottom: 50px; /* Lifted higher */
            width: 260px; 
            background: var(--dock-bg); backdrop-filter: blur(var(--dock-blur));
            border: 1px solid var(--dock-border); border-radius: 12px;
            padding: 15px; padding-top: 25px; /* Space for Close X */
            color: var(--text-body);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            display: none; flex-direction: column; gap: 15px;
            pointer-events: auto; cursor: default; 
            z-index: 300; /* Higher than dock content */
        }
        #settings-popup.show { display: flex; animation: popupFade 0.2s ease-out; }
        @keyframes popupFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .settings-close-btn {
            position: absolute; top: 8px; right: 8px;
            background: transparent; border: none; color: var(--text-dim);
            font-size: 14px; cursor: pointer; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px; transition: all 0.2s;
        }
        .settings-close-btn:hover { background: rgba(255, 68, 68, 0.1); color: #ff4444; }

        .settings-section { display: flex; flex-direction: column; gap: 8px; }
        .settings-header { 
            font-family: 'JetBrains Mono'; 
            font-size: calc(var(--font-size-base) - 2px);
            color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; margin-bottom: 4px; 
        }
        .settings-row { display: flex; justify-content: space-between; align-items: center; font-size: var(--font-size-base); }
        
        /* TASK MANAGER STYLES */
        .task-list { display: flex; flex-direction: column; gap: 2px; max-height: 150px; overflow-y: auto; }
        .task-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 4px; border-radius: 4px;
            transition: background 0.2s;
        }
        .task-item:hover { background: rgba(255,255,255,0.03); }
        .task-info { display: flex; align-items: center; gap: 8px; font-size: 11px; }
        .task-status { width: 6px; height: 6px; border-radius: 50%; background: #333; }
        .task-status.visible { background: #00ff88; box-shadow: 0 0 4px rgba(0,255,136,0.4); }
        .task-status.background { background: #ffcc00; }
        .task-kill-btn {
            background: transparent; color: var(--text-dim); border: 1px solid var(--border-color);
            border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 10px;
            font-family: 'JetBrains Mono'; text-transform: uppercase;
        }
        .task-kill-btn:hover { background: rgba(255,68,68,0.1); color: #ff4444; border-color: #ff4444; }
        .empty-tasks { font-size: 11px; color: var(--text-dim); font-style: italic; padding: 5px; text-align: center; }

        .toggle-switch { position: relative; width: 32px; height: 18px; display: inline-block; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 18px; }
        .toggle-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: var(--text-dim); transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--brand-purple); }
        input:checked + .toggle-slider:before { transform: translateX(14px); background-color: white; }

        input[type=range] { -webkit-appearance: none; width: 100px; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--brand-purple); margin-top: -5px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--border-color); border-radius: 2px; }
        input[type=range]:focus { outline: none; }

        /* =========================================
           MEDIA QUERIES - TABLET & DESKTOP (> 600px)
           ========================================= */
        @media (min-width: 601px) {
            #dock-content { flex-direction: row; left: 50%; transform: translateX(-50%); }
            #floating-dock.dock-collapsed:not(.pinned-open) #dock-content { transform: translateX(-50%) translateY(10px) scale(0.8); }
            .dock-btn { width: 44px; height: 44px; font-size: 20px; }
            
            .resize-handle {
                width: 15px; height: 15px; cursor: nwse-resize;
                border-bottom: 2px solid var(--border-color);
                border-right: 2px solid var(--border-color);
                border-bottom-right-radius: 8px;
            }

            .dock-btn::after {
                content: attr(title); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
                background: var(--bg-panel); border: 1px solid var(--border-color); color: var(--text-head);
                font-size: calc(var(--font-size-base) - 2px); padding: 4px 8px; border-radius: 4px; white-space: nowrap; opacity: 0; 
                pointer-events: none; font-family: 'JetBrains Mono'; transition: opacity 0.2s;
            }
            .dock-btn:hover::after { opacity: 1; }

            #floating-dock.fixed-mode {
                top: auto !important; left: 50% !important; bottom: 30px !important; right: auto !important;
                transform: translateX(-50%) !important; width: auto; height: auto;
                transition: bottom 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            }
            #floating-dock.fixed-mode #dock-handle { display: none; }
            #floating-dock.fixed-mode #dock-content {
                position: relative; bottom: auto; margin-bottom: 0; left: auto;
                transform: none !important; opacity: 1 !important; visibility: visible;
                background: rgba(15, 15, 15, 0.6); backdrop-filter: blur(25px) saturate(180%);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
                padding: 12px 16px; gap: 12px; border-radius: 24px;
            }
            body[data-theme="light"] #floating-dock.fixed-mode #dock-content {
                background: rgba(255, 255, 255, 0.65); border: 1px solid rgba(255, 255, 255, 0.4);
                box-shadow: 0 20px 50px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
            }
            #floating-dock.fixed-mode .dock-btn { transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); margin: 0 2px; }
            #floating-dock.fixed-mode .dock-btn:hover {
                transform: translateY(-8px) scale(1.2); background: var(--brand-purple); color: white;
                box-shadow: 0 10px 20px var(--brand-purple-dim); z-index: 100; margin: 0 8px;
            }
            #floating-dock.fixed-mode #settings-popup {
                bottom: 100%; right: 50%; transform: translateX(50%);
                margin-bottom: 50px; /* Lifted higher here too */
                transform-origin: bottom center;
            }
            #floating-dock.fixed-mode #settings-popup.show { animation: popupFixedUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
            @keyframes popupFixedUp { from { opacity: 0; transform: translateX(50%) translateY(20px) scale(0.9); } to { opacity: 1; transform: translateX(50%) translateY(0) scale(1); } }
        }

        /* =========================================
           MEDIA QUERIES - PHONE ONLY (<= 600px)
           ========================================= */
        @media (max-width: 600px) {
            body { overflow-y: auto; height: auto; }
            #top-system-bar { display: none !important; }
            #desktop-area { position: relative; top: 0; height: auto; padding: 20px; padding-bottom: 120px; }
            .lyrn-window { position: relative !important; width: 100% !important; height: 500px; margin-bottom: 20px; }
            #dock-content { flex-direction: column-reverse; left: 50%; transform: translateX(-50%); z-index: 100; }
            #floating-dock.dock-collapsed:not(.pinned-open) #dock-content { transform: translateX(-50%) translateY(10px) scale(0.8); }
            /* Explicitly raise handle Z-index above content for mobile touch targets */
            #dock-handle { z-index: 200; } 
            
            .dock-btn { width: 40px; height: 40px; font-size: 18px; }
            .dock-btn::after { display: none; }
            .desktop-only-setting { display: none !important; }
            .resize-handle { width: 100%; height: 24px; bottom: 0; left: 0; cursor: ns-resize; display: flex; align-items: center; justify-content: center; }
            .resize-handle::before { content: ''; width: 40px; height: 4px; background: var(--border-color); border-radius: 2px; }
            #settings-popup { right: -20px; bottom: 120%; }
        }
    </style>
</head>
<body data-theme="dark">

    <div id="top-system-bar">
        <div class="bar-section">
            <span class="system-clock" id="sys-clock">...</span>
        </div>
        <div class="bar-section">
            <button class="bar-btn" title="Reset Dock Position" onclick="resetDock()">‚öì</button>
            <button class="bar-btn" title="Toggle Fullscreen" onclick="toggleDashboardFullscreen()">‚õ∂</button>
            <button class="bar-btn close-iframe-btn" id="btn-close-iframe" title="Close Dashboard" onclick="closeDashboard()">‚úï</button>
        </div>
    </div>

    <div id="desktop-area"></div>

    <div id="floating-dock" class="dock-collapsed">
        <div id="settings-popup">
            <button class="settings-close-btn" onclick="document.getElementById('settings-popup').classList.remove('show')" title="Close Settings">‚úï</button>
            
            <div class="settings-section">
                <div class="settings-header">Active Processes</div>
                <div id="task-manager-list" class="task-list">
                    <div class="empty-tasks">No active processes</div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-header">Quick Settings</div>
                <div class="settings-row">
                    <span>Dark Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-theme" checked onchange="toggleTheme(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-row" id="row-dock-pin">
                    <span>Pin Dock Open</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-dock-pin" onchange="toggleDockPin(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-row desktop-only-setting">
                    <span>Fixed Center Dock</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="setting-dock-fixed" onchange="toggleFixedDock(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-row" style="flex-direction: column; align-items: flex-start; gap: 5px;">
                    <div style="display:flex; justify-content:space-between; width:100%;">
                        <span>Font Size</span>
                        <span id="font-size-display" style="font-family:'JetBrains Mono'; color:var(--brand-purple);">12px</span>
                    </div>
                    <input type="range" id="setting-font-size" min="10" max="18" step="1" value="12" oninput="toggleFontSize(this.value)">
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-header">Modules</div>
                <div id="module-list-container"></div>
            </div>
        </div>

        <div id="dock-content"></div>

        <div id="dock-handle" title="Drag to move, Click to toggle">
            <div class="handle-bar"></div>
        </div>
    </div>

    <div id="welcome-overlay">
        <div class="welcome-modal">
            <button class="welcome-close-x" onclick="closeWelcome()" title="Close">‚úï</button>
            
            <h2 class="welcome-title">
                <span style="color:var(--brand-purple);">‚ùñ</span> LYRN Systems
            </h2>
            
            <p class="welcome-text">
                Welcome to the v0.38 dashboard environment. 
                Use the floating dock to access your modules.
            </p>

            <div class="welcome-feature">
                <div class="welcome-icon">‚öì</div>
                <div>
                    <strong>Floating Dock</strong><br>
                    Click the handle to open/close. Drag the handle to move the dock anywhere on screen.
                </div>
            </div>

            <div class="welcome-feature">
                <div class="welcome-icon">‚Ü∫</div>
                <div>
                    <strong>Lost the dock?</strong><br>
                    Click the Anchor icon (‚öì) in the top-left system bar to reset the dock to the center of the screen.
                </div>
            </div>

            <div class="welcome-footer">
                <label class="welcome-checkbox">
                    <input type="checkbox" id="dont-show-welcome">
                    Don't show this again
                </label>
                <button class="welcome-btn" onclick="closeWelcome()">Initialize</button>
            </div>
        </div>
    </div>

    <script>
        /* =========================================================================
           CONFIG: DOCK APP MANIFEST
           ========================================================================= */
        const MODULE_REGISTRY = [
            { id: "mod_builder", file: "Snapshot Builder.html", name: "Snapshot Builder", icon: "üõ†Ô∏è" },
            { id: "mod_job_manager", file: "Job Manager.html", name: "Job Automation", icon: "ü§ñ" },
        ];
        /* ========================================================================= */

        /* --- GLOBAL STATE --- */
        let zIndexCounter = 100;
        // activeWindows now tracks open windows (hidden or visible)
        let activeWindows = new Set(); 
        const GRID_SIZE = 20; 
        
        let appSettings = {
            activeModules: ['mod_builder', 'mod_job_manager'],
            dockPinned: false,
            dockFixed: false,
            theme: 'dark',
            fontSize: 12
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            renderDock();
            initFloatingDock();
            initSettingsUI();
            startClock();
            checkIfIframe();
            initWelcome(); // Check and show welcome modal
            
            document.body.setAttribute('data-theme', appSettings.theme);
            document.getElementById('setting-theme').checked = (appSettings.theme === 'dark');
            
            document.documentElement.style.setProperty('--font-size-base', appSettings.fontSize + 'px');
            document.getElementById('setting-font-size').value = appSettings.fontSize;
            document.getElementById('font-size-display').innerText = appSettings.fontSize + 'px';

            if(appSettings.dockPinned) {
                document.getElementById('floating-dock').classList.add('pinned-open');
                document.getElementById('setting-dock-pin').checked = true;
            }

            if(appSettings.dockFixed) {
                toggleFixedDock(true, false); 
                document.getElementById('setting-dock-fixed').checked = true;
            }
        });

        /* =========================================
           WELCOME MODAL LOGIC
           ========================================= */
        function initWelcome() {
            const hasSeen = localStorage.getItem('lyrn-welcome-v038');
            if (!hasSeen) {
                document.getElementById('welcome-overlay').style.display = 'flex';
            }
        }

        function closeWelcome() {
            const checkbox = document.getElementById('dont-show-welcome');
            if (checkbox.checked) {
                localStorage.setItem('lyrn-welcome-v038', 'true');
            }
            const overlay = document.getElementById('welcome-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        // --- CLOCK FUNCTION ---
        function startClock() {
            const el = document.getElementById('sys-clock');
            const update = () => {
                const now = new Date();
                // Format: Mon, Dec 10  09:41 PM
                const datePart = now.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
                const timePart = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                el.innerText = `${datePart}   ${timePart}`;
            };
            update();
            setInterval(update, 1000); // Update every second
        }

        // --- DOCK RESET ---
        function resetDock() {
            const dock = document.getElementById('floating-dock');
            // Clear local storage for position
            localStorage.removeItem('lyrn-dock-xy');
            // Reset Styles
            dock.style.left = '50%';
            dock.style.top = '50%';
            dock.style.transform = 'translate(-50%, -50%)';
            dock.style.bottom = 'auto';
            dock.style.right = 'auto';
            // Force open so user sees it
            dock.classList.remove('dock-collapsed');
            // Re-render buttons in case of DOM error
            renderDock();
        }

        // --- FULLSCREEN TOGGLE ---
        function toggleDashboardFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- IFRAME DETECTION & CLOSE ---
        function checkIfIframe() {
            try {
                if (window.self !== window.top) {
                    // We are in an iframe
                    document.getElementById('btn-close-iframe').style.display = 'flex';
                }
            } catch (e) {
                // Cross-origin might block access, but we can assume iframe if error or specific context
                document.getElementById('btn-close-iframe').style.display = 'flex';
            }
        }

        function closeDashboard() {
            // Check if we are in fullscreen mode
            if (document.fullscreenElement) {
                // Exit fullscreen FIRST, then send the close message
                document.exitFullscreen()
                    .then(() => window.parent.postMessage({ type: 'CLOSE_DASHBOARD' }, '*'))
                    .catch(err => {
                        console.error("Fullscreen exit error:", err);
                        // Force close anyway if exit fails
                        window.parent.postMessage({ type: 'CLOSE_DASHBOARD' }, '*');
                    });
            } else {
                // Not in fullscreen, just close
                window.parent.postMessage({ type: 'CLOSE_DASHBOARD' }, '*');
            }
        }

        function loadSettings() {
            const saved = localStorage.getItem('lyrn-settings');
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appSettings = { ...appSettings, ...parsed };
                    if(!appSettings.fontSize) appSettings.fontSize = 12;
                } catch(e) { console.error("Settings parse error", e); }
            }
        }

        function saveSettings() {
            localStorage.setItem('lyrn-settings', JSON.stringify(appSettings));
        }

        function renderDock() {
            const container = document.getElementById('dock-content');
            const modContainer = document.getElementById('module-list-container');
            container.innerHTML = '';
            modContainer.innerHTML = '';
            
            MODULE_REGISTRY.forEach(mod => {
                const isActive = appSettings.activeModules.includes(mod.id);
                const row = document.createElement('div');
                row.className = 'settings-row';
                row.innerHTML = `<span>${mod.name}</span><label class="toggle-switch"><input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleModuleActive('${mod.id}', this.checked)"><span class="toggle-slider"></span></label>`;
                modContainer.appendChild(row);

                if(isActive) {
                    const btn = document.createElement('button');
                    btn.className = 'dock-btn';
                    btn.id = 'btn_' + mod.id; 
                    btn.title = mod.name;
                    btn.innerHTML = mod.icon;
                    
                    // Update initial state indicators if window exists from before (unlikely on reload but good for safety)
                    if(document.getElementById('win_' + mod.id)) {
                        btn.classList.add('is-running');
                    }

                    btn.onclick = (e) => {
                        e.stopPropagation();
                        toggleWindow(mod);
                        if(window.innerWidth <= 600 && !appSettings.dockPinned) {
                            document.getElementById('floating-dock').classList.add('dock-collapsed');
                        }
                    };
                    container.appendChild(btn);
                }
            });
            
            const sep = document.createElement('div');
            sep.style.cssText = window.innerWidth <= 600 
                ? "height:1px; width:20px; background:var(--border-color); opacity:0.5; margin:4px auto;"
                : "width:1px; height:20px; background:var(--border-color); opacity:0.5; margin:0 4px;";
            container.appendChild(sep);

            const settingsBtn = document.createElement('button');
            settingsBtn.className = 'dock-btn';
            settingsBtn.innerHTML = '‚öôÔ∏è';
            settingsBtn.title = 'Settings';
            settingsBtn.id = 'btn_settings';
            settingsBtn.onclick = (e) => {
                e.stopPropagation();
                renderTaskManager(); // Refresh task list on open
                document.getElementById('settings-popup').classList.toggle('show');
            };
            container.appendChild(settingsBtn);
        }

        function toggleModuleActive(modId, isChecked) {
            if(isChecked) {
                if(!appSettings.activeModules.includes(modId)) appSettings.activeModules.push(modId);
            } else {
                appSettings.activeModules = appSettings.activeModules.filter(id => id !== modId);
            }
            saveSettings(); renderDock(); 
        }

        function toggleTheme(isDark) {
            const theme = isDark ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            appSettings.theme = theme;
            saveSettings();
            document.querySelectorAll('iframe').forEach(frame => {
                frame.contentWindow.postMessage({ type: 'THEME_CHANGE', theme: theme }, '*');
            });
        }
        
        function toggleFontSize(val) {
            const size = parseInt(val);
            appSettings.fontSize = size;
            document.getElementById('font-size-display').innerText = size + 'px';
            document.documentElement.style.setProperty('--font-size-base', size + 'px');
            saveSettings();
            document.querySelectorAll('iframe').forEach(frame => {
                frame.contentWindow.postMessage({ type: 'FONT_CHANGE', fontSize: size }, '*');
            });
        }

        function toggleDockPin(pinned) {
            appSettings.dockPinned = pinned;
            const dock = document.getElementById('floating-dock');
            if(pinned) dock.classList.add('pinned-open'); else dock.classList.remove('pinned-open');
            saveSettings();
        }

        function toggleFixedDock(isFixed, save = true) {
            appSettings.dockFixed = isFixed;
            const dock = document.getElementById('floating-dock');
            const pinRow = document.getElementById('row-dock-pin');
            if (isFixed) {
                dock.classList.add('fixed-mode');
                if(pinRow) { pinRow.style.opacity = '0.3'; pinRow.style.pointerEvents = 'none'; }
            } else {
                dock.classList.remove('fixed-mode');
                const savedPos = localStorage.getItem('lyrn-dock-xy');
                if (savedPos) {
                    const { left, top } = JSON.parse(savedPos);
                    dock.style.left = left + 'px'; dock.style.top = top + 'px'; dock.style.transform = 'none';
                } else {
                    dock.style.top = '50%'; dock.style.left = '50%'; dock.style.transform = 'translate(-50%, -50%)';
                }
                if(pinRow) { pinRow.style.opacity = '1'; pinRow.style.pointerEvents = 'auto'; }
            }
            if (save) saveSettings();
        }

        function initSettingsUI() {
            document.addEventListener('click', (e) => {
                const popup = document.getElementById('settings-popup');
                const btn = document.getElementById('btn_settings');
                // Ensure clicks inside the popup don't close it, but clicking outside does
                if(popup.classList.contains('show') && !popup.contains(e.target) && !btn.contains(e.target)) {
                    popup.classList.remove('show');
                }
            });
        }

        /* =========================================
           TASK MANAGER LOGIC
           ========================================= */
        function renderTaskManager() {
            const list = document.getElementById('task-manager-list');
            list.innerHTML = '';
            
            if(activeWindows.size === 0) {
                list.innerHTML = '<div class="empty-tasks">No active processes</div>';
                return;
            }

            activeWindows.forEach(modId => {
                const mod = MODULE_REGISTRY.find(m => m.id === modId);
                const win = document.getElementById('win_' + modId);
                if(!mod || !win) return;

                const isVisible = win.style.display !== 'none';
                const item = document.createElement('div');
                item.className = 'task-item';
                item.innerHTML = `
                    <div class="task-info">
                        <div class="task-status ${isVisible ? 'visible' : 'background'}" title="${isVisible ? 'Visible' : 'Background'}"></div>
                        <span>${mod.name}</span>
                    </div>
                    <button class="task-kill-btn" onclick="killProcess('${modId}')">Kill</button>
                `;
                list.appendChild(item);
            });
        }

        window.killProcess = (modId) => {
            closeWindow(modId);
        };


        /* =========================================
           WINDOW SYSTEM UPDATES
           ========================================= */
        
        // Modified toggle logic:
        // 1. If not created -> Create
        // 2. If created and Hidden -> Show & Focus
        // 3. If created and Visible -> 
        //      If Focused (Top zIndex) -> Hide (Minimize)
        //      If Background -> Bring to front
        function toggleWindow(mod) {
            const winId = 'win_' + mod.id;
            const existingWin = document.getElementById(winId);

            if (!existingWin) {
                createWindow(mod, winId);
            } else {
                if (existingWin.style.display === 'none') {
                    // Restore
                    existingWin.style.display = 'flex';
                    bringToFront(existingWin);
                } else {
                    // Check if it's the top-most window
                    const currentZ = parseInt(existingWin.style.zIndex || 0);
                    if (currentZ === zIndexCounter) {
                        // Minimize
                        existingWin.style.display = 'none';
                        updateDockIndicators(); // Update focus states
                    } else {
                        // Focus
                        bringToFront(existingWin);
                    }
                }
            }
            renderTaskManager();
        }

        function bringToFront(win) {
            if(!win.classList.contains('always-on-top')) {
                win.style.zIndex = ++zIndexCounter;
            }
            updateDockIndicators();
        }

        function createWindow(mod, id) {
            const isPhone = window.innerWidth <= 600;
            const area = document.getElementById('desktop-area');
            const win = document.createElement('div');
            win.className = 'lyrn-window active';
            win.id = id;
            win.style.zIndex = ++zIndexCounter;
            
            // Bring to front on click
            win.onmousedown = () => { 
                if(!win.classList.contains('always-on-top')) win.style.zIndex = ++zIndexCounter; 
                updateDockIndicators();
            };

            if(!isPhone) {
                const offset = (activeWindows.size * 30) % 150;
                win.style.left = (100 + offset) + 'px'; win.style.top = (50 + offset) + 'px';
            }

            win.innerHTML = `
                <div class="window-header">
                    <span class="window-title">${mod.name}</span>
                    <div class="win-controls">
                         <button class="win-btn" title="Pin Position" onclick="toggleLock(this)">üìå</button>
                         <button class="win-btn" title="Always On Top" onclick="toggleAlwaysOnTop(this)">‚áß</button>
                         <button class="win-btn" title="Maximize" onclick="toggleMaximize(this)">‚òê</button>
                         <button class="win-btn close-btn" title="Terminate Process" onclick="killProcess('${mod.id}')">‚úï</button>
                    </div>
                </div>
                <div class="window-content">
                    <div class="iframe-shield"></div>
                    <iframe src="modules/${mod.file}" onload="syncFrameTheme(this)"></iframe>
                </div>
                <div class="resize-handle"></div>
            `;
            area.appendChild(win);
            
            activeWindows.add(mod.id);
            setupWindowInteractions(win, isPhone);
            updateDockIndicators();
            renderTaskManager();
        }

        function closeWindow(modId) {
            const win = document.getElementById('win_' + modId);
            if(win) {
                win.style.opacity = '0'; 
                win.style.transform = 'scale(0.9)';
                setTimeout(() => win.remove(), 200);
                activeWindows.delete(modId);
                updateDockIndicators();
                renderTaskManager();
            }
        }

        function updateDockIndicators() {
            // Reset all
            document.querySelectorAll('.dock-btn').forEach(btn => {
                btn.classList.remove('is-running');
                btn.classList.remove('is-focused');
            });

            // Set running status
            activeWindows.forEach(modId => {
                const btn = document.getElementById('btn_' + modId);
                if(btn) btn.classList.add('is-running');
            });

            // Find top-most visible window for focus
            let topZ = 0;
            let topWinId = null;
            
            activeWindows.forEach(modId => {
                const win = document.getElementById('win_' + modId);
                if(win && win.style.display !== 'none') {
                    const z = parseInt(win.style.zIndex || 0);
                    if(z > topZ) {
                        topZ = z;
                        topWinId = modId;
                    }
                }
            });

            if(topWinId) {
                const btn = document.getElementById('btn_' + topWinId);
                if(btn) btn.classList.add('is-focused');
            }
        }

        window.syncFrameTheme = (iframe) => {
            iframe.contentWindow.postMessage({ type: 'THEME_CHANGE', theme: appSettings.theme }, '*');
            iframe.contentWindow.postMessage({ type: 'FONT_CHANGE', fontSize: appSettings.fontSize }, '*');
        };

        window.toggleAlwaysOnTop = (btn) => {
            const win = btn.closest('.lyrn-window');
            if(win.classList.contains('always-on-top')) {
                win.classList.remove('always-on-top'); btn.classList.remove('is-active');
                win.style.zIndex = ++zIndexCounter; 
            } else {
                win.classList.add('always-on-top'); btn.classList.add('is-active');
            }
        };

        window.toggleLock = (btn) => {
            const win = btn.closest('.lyrn-window');
            if(win.classList.contains('locked')) {
                win.classList.remove('locked'); btn.classList.remove('is-locked');
            } else {
                win.classList.add('locked'); btn.classList.add('is-locked');
            }
        };

        window.toggleMaximize = (btn) => {
            const win = btn.closest('.lyrn-window');
            if (win.classList.contains('maximized')) {
                win.classList.remove('maximized'); btn.innerText = '‚òê';
                win.style.left = win.dataset.prevLeft; win.style.top = win.dataset.prevTop;
                win.style.width = win.dataset.prevWidth; win.style.height = win.dataset.prevHeight;
            } else {
                win.dataset.prevLeft = win.style.left; win.dataset.prevTop = win.style.top;
                win.dataset.prevWidth = win.style.width; win.dataset.prevHeight = win.style.height;
                win.classList.add('maximized'); btn.innerText = '‚ùê';
                win.style.left = '0px'; win.style.top = '0px'; win.style.width = '100%'; win.style.height = '100%';
            }
        };

        function setupWindowInteractions(win, isPhone) {
            if(!isPhone) {
                const header = win.querySelector('.window-header');
                header.onmousedown = (e) => {
                    if(e.target.closest('button')) return; 
                    if(win.classList.contains('locked') || win.classList.contains('maximized')) return;
                    if(!win.classList.contains('always-on-top')) win.style.zIndex = ++zIndexCounter;
                    updateDockIndicators();
                    win.classList.add('is-dragging'); document.body.classList.add('no-select'); document.body.classList.add('global-interaction');
                    
                    const sx = e.clientX, sy = e.clientY;
                    const il = win.offsetLeft, it = win.offsetTop;
                    const winW = win.offsetWidth, winH = win.offsetHeight;
                    const screenW = window.innerWidth, screenH = window.innerHeight;

                    const moveHandler = (me) => {
                        let rawLeft = il + (me.clientX - sx); let rawTop = it + (me.clientY - sy);
                        let snapLeft = Math.round(rawLeft / GRID_SIZE) * GRID_SIZE; let snapTop = Math.round(rawTop / GRID_SIZE) * GRID_SIZE;
                        const maxLeft = screenW - winW; const maxTop = screenH - winH;
                        win.style.left = Math.max(0, Math.min(snapLeft, maxLeft)) + 'px';
                        win.style.top = Math.max(0, Math.min(snapTop, maxTop)) + 'px';
                    };

                    const upHandler = () => {
                        win.classList.remove('is-dragging'); document.body.classList.remove('no-select'); document.body.classList.remove('global-interaction');
                        document.removeEventListener('mousemove', moveHandler); document.removeEventListener('mouseup', upHandler);
                    };
                    document.addEventListener('mousemove', moveHandler); document.addEventListener('mouseup', upHandler);
                };
            }

            const resizer = win.querySelector('.resize-handle');
            resizer.onmousedown = (e) => {
                e.stopPropagation();
                if(win.classList.contains('locked') || win.classList.contains('maximized')) return;
                if(!win.classList.contains('always-on-top')) win.style.zIndex = ++zIndexCounter;
                updateDockIndicators();
                win.classList.add('is-resizing'); document.body.classList.add('no-select'); document.body.classList.add('global-interaction');

                const startX = e.clientX, startY = e.clientY;
                const startW = win.offsetWidth, startH = win.offsetHeight;

                const resizeMove = (me) => {
                    const dx = me.clientX - startX; const dy = me.clientY - startY;
                    let newH = startH + dy;
                    if (!isPhone) newH = Math.round(newH / GRID_SIZE) * GRID_SIZE;
                    if (newH > 100) win.style.height = newH + 'px';
                    if (!isPhone) {
                        let newW = startW + dx; newW = Math.round(newW / GRID_SIZE) * GRID_SIZE;
                        if (newW > 200) win.style.width = newW + 'px';
                    }
                };

                const resizeUp = () => {
                    win.classList.remove('is-resizing'); document.body.classList.remove('no-select'); document.body.classList.remove('global-interaction');
                    document.removeEventListener('mousemove', resizeMove); document.removeEventListener('mouseup', resizeUp);
                };
                document.addEventListener('mousemove', resizeMove); document.addEventListener('mouseup', resizeUp);
            };
            
            resizer.ontouchstart = (e) => {
                e.stopPropagation();
                if(win.classList.contains('locked')) return;
                win.classList.add('is-resizing');
                const startY = e.touches[0].clientY; const startH = win.offsetHeight;
                const touchMove = (te) => { const dy = te.touches[0].clientY - startY; let newH = startH + dy; if (newH > 100) win.style.height = newH + 'px'; };
                const touchEnd = () => { win.classList.remove('is-resizing'); document.removeEventListener('touchmove', touchMove); document.removeEventListener('touchend', touchEnd); };
                document.addEventListener('touchmove', touchMove, {passive: false}); document.addEventListener('touchend', touchEnd);
            };
        }

        function initFloatingDock() {
            const dock = document.getElementById('floating-dock');
            const handle = document.getElementById('dock-handle');
            const savedPos = localStorage.getItem('lyrn-dock-xy');
            
            // --- FIX FOR REAPPEARING DOCK ---
            if (savedPos && !appSettings.dockFixed) {
                try {
                    const { left, top } = JSON.parse(savedPos);
                    // Sanity check bounds
                    if (left < 0 || top < 0 || left > window.innerWidth || top > window.innerHeight) {
                            throw new Error("Coordinates out of bounds");
                    }
                    dock.style.bottom = 'auto'; dock.style.right = 'auto';
                    dock.style.left = left + 'px'; dock.style.top = top + 'px';
                    dock.style.transform = 'none'; 
                } catch(e) { 
                    dock.style.top = '50%'; dock.style.left = '50%'; dock.style.transform = 'translate(-50%, -50%)'; 
                }
            } else {
                    if(!appSettings.dockFixed) {
                    dock.style.top = '50%'; dock.style.left = '50%'; dock.style.transform = 'translate(-50%, -50%)';
                    }
            }

            let isDragging = false, hasMoved = false;
            let startX, startY, initL, initT;

            const startDrag = (e) => {
                if(appSettings.dockFixed) return; 
                
                // --- FIX START: PREVENT DOUBLE FIRING ---
                // On mobile, prevent the browser from firing a simulated 'mousedown' 
                // after the 'touchstart', which causes the dock to toggle twice (Open then immediately Close).
                if(e.type === 'touchstart') {
                    e.preventDefault();
                }
                // --- FIX END ---

                isDragging = true; hasMoved = false; 
                dock.classList.add('is-dragging'); 
                document.body.classList.add('no-select');
                
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                
                startX = clientX; startY = clientY;
                const rect = dock.getBoundingClientRect(); initL = rect.left; initT = rect.top;
                
                dock.style.transform = 'none'; dock.style.bottom = 'auto'; dock.style.right = 'auto'; 
                dock.style.left = initL + 'px'; dock.style.top = initT + 'px';
                
                document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, {passive:false}); document.addEventListener('touchend', onEnd);
            };

            const onMove = (e) => {
                if(!isDragging) return; 
                e.preventDefault(); // Keep this to prevent scrolling while dragging
                
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                
                if(Math.abs(clientX - startX) > 6 || Math.abs(clientY - startY) > 6) hasMoved = true;
                
                dock.style.left = (initL + (clientX - startX)) + 'px'; 
                dock.style.top = (initT + (clientY - startY)) + 'px';
            };

            const onEnd = () => {
                isDragging = false; 
                dock.classList.remove('is-dragging'); 
                document.body.classList.remove('no-select');
                
                document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd);
                
                if(!hasMoved) { 
                    if(!appSettings.dockPinned && !appSettings.dockFixed) {
                        dock.classList.toggle('dock-collapsed'); 
                    }
                } else {
                    const rect = dock.getBoundingClientRect();
                    const snapL = Math.round(rect.left / GRID_SIZE) * GRID_SIZE; 
                    const snapT = Math.round(rect.top / GRID_SIZE) * GRID_SIZE;
                    dock.style.left = snapL + 'px'; dock.style.top = snapT + 'px';
                    localStorage.setItem('lyrn-dock-xy', JSON.stringify({left: snapL, top: snapT}));
                }
            };

            handle.addEventListener('mousedown', startDrag); 
            // Note: 'passive: false' is required for preventDefault to work
            handle.addEventListener('touchstart', startDrag, {passive: false});
        }
    </script>
</body>
</html>