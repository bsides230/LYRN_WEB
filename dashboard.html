<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LYRN Dashboard v0.52 (Smart Dock)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />

    <style>
        /* =========================================
           1. CORE VARIABLES & THEME
           ========================================= */
        :root {
            --bg-core: #050505;
            --bg-panel: #0a0a0a;
            --brand-purple: #7c5cff;
            --brand-purple-dim: rgba(124, 92, 255, 0.1);
            --brand-purple-glow: rgba(124, 92, 255, 0.4);
            --text-head: #ffffff;
            --text-body: #b0b0b0;
            --text-dim: #666666;
            --border-color: #222222;
            
            --dock-bg: rgba(20, 20, 20, 0.6);
            --dock-border: rgba(255, 255, 255, 0.1);
            --dock-blur: 20px;

            --font-size-base: 12px;
        }

        body[data-theme="light"] {
            --bg-core: #eef0f4;
            --bg-panel: #ffffff;
            --brand-purple: #6a4ce0;
            --brand-purple-dim: rgba(106, 76, 224, 0.1);
            --brand-purple-glow: rgba(106, 76, 224, 0.3);
            --text-head: #111111;
            --text-body: #333333;
            --text-dim: #555555;
            --border-color: #d1d5db;
            --dock-bg: rgba(255, 255, 255, 0.6);
            --dock-border: rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0; width: 100vw; 
            min-height: 100vh; overflow: hidden; 
            background-color: var(--bg-core);
            font-family: 'Inter', system-ui, sans-serif;
            color: var(--text-body);
            transition: background-color 0.5s ease;
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(124, 92, 255, 0.03) 10px, rgba(124, 92, 255, 0.03) 11px),
                radial-gradient(circle at 50% 0%, rgba(124, 92, 255, 0.15) 0%, transparent 60%);
            background-size: auto, 100% 100%;
            background-attachment: fixed;
            font-size: var(--font-size-base);
        }
        
        body.no-select * {
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        /* =========================================
           TOP SYSTEM BAR
           ========================================= */
        #top-system-bar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 32px;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            z-index: 10000;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            user-select: none;
        }

        .bar-section { display: flex; align-items: center; gap: 15px; }
        .system-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: var(--text-head);
            letter-spacing: 0.05em; cursor: help;
        }
        #sys-cpu { color: #7c5cff; } 
        .bar-btn {
            background: transparent; border: none; color: var(--text-dim);
            cursor: pointer; font-family: 'JetBrains Mono'; font-size: 14px;
            padding: 4px; display: flex; align-items: center; justify-content: center;
            transition: color 0.2s;
        }
        .bar-btn:hover { color: var(--text-head); }
        .bar-btn.close-iframe-btn { color: #ff4444; margin-left: 10px; }
        #btn-close-iframe { display: none; }

        /* =========================================
           WINDOW SYSTEM
           ========================================= */
        #desktop-area { position: absolute; top: 32px; left: 0; right: 0; bottom: 0; z-index: 1; pointer-events: none; }
        
        .lyrn-window {
            pointer-events: auto;
            position: absolute; background: var(--bg-panel); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border-radius: 8px; width: 800px; height: 600px;
            min-width: 300px; min-height: 200px;
            transition: box-shadow 0.2s, opacity 0.2s, transform 0.2s;
            opacity: 0; transform: scale(0.95);
            animation: openWin 0.2s forwards ease-out;
        }
        @keyframes openWin { to { opacity: 1; transform: scale(1); } }

        .lyrn-window.active { border-color: var(--brand-purple); box-shadow: 0 25px 70px rgba(0,0,0,0.7), 0 0 15px var(--brand-purple-dim); }
        .lyrn-window.always-on-top { z-index: 9999 !important; border: 1px solid var(--brand-purple); box-shadow: 0 0 0 1px var(--brand-purple); }
        .lyrn-window.maximized { transition: width 0.2s, height 0.2s, left 0.2s, top 0.2s; }

        .window-header {
            height: 36px; background: var(--bg-panel); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; padding: 0 8px 0 12px;
            cursor: grab; user-select: none; flex-shrink: 0;
        }
        .window-header:active { cursor: grabbing; }
        .window-title { font-family: 'JetBrains Mono', monospace; font-size: calc(var(--font-size-base) - 1px); text-transform: uppercase; color: var(--text-dim); }
        
        .win-controls { display: flex; align-items: center; gap: 6px; }
        .win-btn {
            background: transparent; border: none; color: var(--text-dim);
            width: 24px; height: 24px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: var(--font-size-base);
            transition: all 0.2s;
        }
        .win-btn:hover { background: var(--brand-purple-dim); color: var(--text-head); }
        
        .window-content { flex: 1; position: relative; background: var(--bg-core); overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; }
        .iframe-shield { position: absolute; top:0; left:0; width:100%; height:100%; z-index:10; display:none; }
        .lyrn-window.is-dragging .iframe-shield, .lyrn-window.is-resizing .iframe-shield { display: block; }

        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 25px; height: 25px;
            z-index: 20; opacity: 0; cursor: nwse-resize;
            transition: opacity 0.2s;
        }
        .resize-handle::after {
            content:''; position: absolute; bottom: 4px; right: 4px;
            width: 8px; height: 8px; border-right: 2px solid var(--brand-purple); border-bottom: 2px solid var(--brand-purple);
            border-radius: 0 0 2px 0;
        }
        .lyrn-window:hover .resize-handle { opacity: 1; }

        /* =========================================
           FLOATING DOCK - CORE
           ========================================= */
        #floating-dock {
            position: fixed; z-index: 20000; 
            display: flex;
            background: var(--dock-bg);
            backdrop-filter: blur(var(--dock-blur));
            -webkit-backdrop-filter: blur(var(--dock-blur));
            border: 1px solid var(--dock-border);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 8px;
            gap: 8px;
            
            /* Disable Selection on Dock */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Dragging State */
        #floating-dock.is-dragging { 
            transition: none; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); 
            border-color: var(--brand-purple); 
            cursor: grabbing;
        }

        /* LAYOUT MODES */
        #floating-dock.horizontal-mode { flex-direction: row; align-items: center; }
        #floating-dock.vertical-mode { flex-direction: column; align-items: center; }

        /* CONTENT CONTAINER */
        #dock-content {
            display: flex; gap: 8px;
            transition: all 0.3s ease;
            overflow: hidden;
            max-width: 500px; /* Default open max width */
            max-height: 500px;
            opacity: 1;
        }
        #floating-dock.horizontal-mode #dock-content { flex-direction: row; }
        #floating-dock.vertical-mode #dock-content { flex-direction: column; }
        
        /* COLLAPSED STATE (Smooth iOS style collapse) */
        #floating-dock.dock-collapsed #dock-content {
            max-width: 0; max-height: 0; opacity: 0; padding: 0; margin: 0; pointer-events: none;
        }
        #floating-dock.vertical-mode.dock-collapsed #dock-content { max-width: 0; max-height: 0; }

        /* HANDLE */
        #dock-handle {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            cursor: grab;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: background 0.2s, transform 0.2s;
        }
        #dock-handle:hover { background: rgba(255,255,255,0.15); }
        #dock-handle:active { cursor: grabbing; background: var(--brand-purple-dim); transform: scale(0.95); }

        /* Handle Dimensions per Mode */
        #floating-dock.horizontal-mode #dock-handle { width: 32px; height: 50px; order: 2; }
        #floating-dock.vertical-mode #dock-handle { width: 50px; height: 32px; order: 2; }

        .handle-bar { background: rgba(255,255,255,0.5); border-radius: 10px; pointer-events: none; }
        #floating-dock.horizontal-mode .handle-bar { width: 4px; height: 20px; }
        #floating-dock.vertical-mode .handle-bar { width: 20px; height: 4px; }

        /* DOCK BUTTONS */
        .dock-btn {
            background: transparent; border: none; cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-head); border-radius: 12px;
            width: 50px; height: 50px; font-size: 24px;
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            background: rgba(255,255,255,0.03);
            border: 1px solid transparent;
            
            /* Disable Selection/Drag on Icons */
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none;
        }
        .dock-btn:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-4px); }
        
        /* WIGGLE ANIMATION */
        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(3deg); }
            100% { transform: rotate(0deg); }
        }
        .dock-btn.wiggle { 
            animation: wiggle 0.3s ease-in-out infinite; 
            background: rgba(255,50,50,0.15); 
            border: 1px solid rgba(255,50,50,0.5); 
            color: #ffcccc;
            transition: none;
        }
        .dock-btn.wiggle:hover { transform: scale(1.05); }

        .active-dot {
            position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; border-radius: 50%;
            background-color: var(--brand-purple);
            box-shadow: 0 0 6px var(--brand-purple); display: none;
        }
        .dock-btn.is-running .active-dot { display: block; }

        /* =========================================
           POPUPS & SETTINGS
           ========================================= */
        #settings-popup {
            position: fixed; 
            width: 260px; background: #0f0f0f; 
            border: 1px solid var(--dock-border); border-radius: 12px;
            padding: 15px; color: var(--text-body);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            display: none; flex-direction: column; gap: 12px;
            z-index: 20001;
        }
        #settings-popup.show { display: flex; animation: fadeUp 0.2s; }
        @keyframes fadeUp { from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }
        
        .settings-header { 
            font-family: 'JetBrains Mono'; font-size: 10px; color: var(--text-dim); 
            text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; 
        }
        .settings-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        
        .btn-full-width {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            color: var(--text-head); padding: 8px; border-radius: 6px; cursor: pointer;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .btn-full-width:hover { background: var(--brand-purple); border-color: var(--brand-purple); }

        /* EDIT POPUP */
        .edit-popup {
            position: fixed; 
            background: #000; border: 1px solid #333; border-radius: 50px;
            padding: 8px; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9); z-index: 20002;
            animation: fadeUp 0.15s ease-out;
            pointer-events: auto;
        }
        .edit-popup-btn {
            background: #1a1a1a; border: none; color: #fff;
            width: 36px; height: 36px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: background 0.2s;
        }
        .edit-popup-btn:hover { background: #333; }
        .edit-popup-btn.danger { color: #ff5555; }
        .edit-popup-btn.danger:hover { background: #500; color: #fff; }
        .edit-popup-sep { width: 1px; height: 20px; background: #333; }

        /* EDIT MODE BANNER */
        #edit-mode-banner {
            position: fixed; top: 40px; left: 50%; transform: translateX(-50%);
            background: var(--brand-purple); color: #fff;
            padding: 8px 16px; border-radius: 30px;
            font-family: 'JetBrains Mono', monospace; font-size: 12px;
            display: none; align-items: center; gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 21000;
        }
        #edit-mode-banner button {
            background: rgba(0,0,0,0.2); border: none; color: white;
            padding: 4px 8px; border-radius: 4px; cursor: pointer;
            font-family: inherit; font-size: 10px; text-transform: uppercase;
        }
        #edit-mode-banner button:hover { background: rgba(0,0,0,0.4); }

        /* Toggle Switch */
        .toggle-switch { position: relative; width: 32px; height: 18px; display: inline-block; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 18px; }
        .toggle-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: var(--text-dim); transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--brand-purple); }
        input:checked + .toggle-slider:before { transform: translateX(14px); background-color: white; }

        /* =========================================
           MEDIA QUERIES
           ========================================= */
        @media (max-width: 500px) {
            .resize-handle { width: 35px; height: 35px; opacity: 1; border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; background:rgba(0,0,0,0.5); bottom: -15px; right: -15px; }
            .resize-handle::after { border-color: white; width: 12px; height: 12px; bottom: 10px; right: 10px; }
        }
    </style>
</head>
<body data-theme="dark">

    <div id="top-system-bar">
        <div class="bar-section">
            <span class="system-text" id="sys-cpu">CPU: 0%</span>
            <span class="system-text" id="sys-date">...</span>
            <span class="system-text" id="sys-clock">...</span>
            <span class="system-text" id="sys-battery"></span>
        </div>
        <div class="bar-section">
            <button class="bar-btn" title="Reset Dock" onclick="resetDock()">‚öì</button>
            <button class="bar-btn" title="Fullscreen" onclick="toggleDashboardFullscreen()">‚õ∂</button>
            <button class="bar-btn close-iframe-btn" id="btn-close-iframe" onclick="closeDashboard()">‚úï</button>
        </div>
    </div>

    <div id="edit-mode-banner">
        <span>EDIT MODE ACTIVE</span>
        <button onclick="disableEditMode()">DONE</button>
    </div>

    <div id="desktop-area"></div>

    <div id="settings-popup">
        <div class="settings-header">General</div>
        <div class="settings-row">
            <span>Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="setting-theme" checked onchange="toggleTheme(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="settings-row">
            <span>Pin Open</span>
            <label class="toggle-switch">
                <input type="checkbox" id="setting-dock-pin" checked onchange="toggleDockPin(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="settings-header" style="margin-top:5px;">Layout</div>
        <button class="btn-full-width" onclick="enableEditMode()">Edit Dock Layout</button>
        
        <div class="settings-header" style="margin-top:5px;">Modules</div>
        <div id="module-list-container"></div>
    </div>

    <div id="floating-dock" class="horizontal-mode">
        <div id="dock-content"></div>

        <div id="dock-handle" title="Drag to Move | Click to Toggle">
            <div class="handle-bar"></div>
        </div>
    </div>

    <script>
        /* =========================================================================
           CONFIG & STATE
           ========================================================================= */
        const MODULE_REGISTRY = [
            { id: "mod_builder", file: "Snapshot Builder.html", name: "Snapshot Builder", icon: "üõ†Ô∏è" },
            { id: "mod_job_manager", file: "Job Manager.html", name: "Job Automation", icon: "ü§ñ" },
            { id: "mod_asset_shop", file: "Asset Shop.html", name: "Asset Shop", icon: "üõçÔ∏è" },
        ];

        let appSettings = {
            activeModules: ['mod_builder', 'mod_job_manager', 'mod_asset_shop'],
            dockPinned: true, 
            dockPos: { x: '50%', y: '90%', orientation: 'horizontal' },
            theme: 'dark'
        };

        let zIndexCounter = 100;
        let activeWindows = new Set();
        let isEditMode = false;
        
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            renderDock();
            initDockDrag();
            startClock();
            startCpuMonitor();
            initSystemMonitor(); 
            checkIfIframe();
            
            document.getElementById('setting-dock-pin').checked = appSettings.dockPinned;
            document.getElementById('setting-theme').checked = (appSettings.theme === 'dark');
            
            // Handle clicking outside
            document.addEventListener('click', (e) => {
                // Settings Popup
                const setPop = document.getElementById('settings-popup');
                if(setPop.classList.contains('show') && !e.target.closest('#settings-popup') && !e.target.closest('#btn_settings')) {
                    setPop.classList.remove('show');
                }
                
                // Edit Mode - Exit if clicking outside dock/popups
                if(isEditMode && !e.target.closest('#floating-dock') && !e.target.closest('.edit-popup') && !e.target.closest('#edit-mode-banner') && !e.target.closest('#settings-popup')) {
                    disableEditMode();
                }
            });
        });

        /* =========================================
           DOCK LOGIC
           ========================================= */
        function renderDock() {
            const container = document.getElementById('dock-content');
            const modContainer = document.getElementById('module-list-container');
            container.innerHTML = '';
            modContainer.innerHTML = '';
            
            // 1. Module List (Settings) - Render from Registry (Fixed Order)
            MODULE_REGISTRY.forEach(mod => {
                const isActive = appSettings.activeModules.includes(mod.id);
                const row = document.createElement('div');
                row.className = 'settings-row';
                row.innerHTML = `<span>${mod.name}</span><label class="toggle-switch"><input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleModuleActive('${mod.id}', this.checked)"><span class="toggle-slider"></span></label>`;
                modContainer.appendChild(row);
            });

            // 2. Dock Icons - Render from ActiveModules (Dynamic Order)
            appSettings.activeModules.forEach(modId => {
                const mod = MODULE_REGISTRY.find(m => m.id === modId);
                if (!mod) return; // Skip if ID invalid

                const btn = document.createElement('button');
                btn.className = 'dock-btn';
                if(isEditMode) btn.classList.add('wiggle'); 
                
                btn.id = 'btn_' + mod.id;
                btn.innerHTML = `${mod.icon}<div class="active-dot"></div>`;
                
                btn.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if(isEditMode) {
                        openEditPopup(e, mod);
                    } else {
                        toggleWindow(mod);
                    }
                };
                container.appendChild(btn);
            });

            // 3. Settings Button
            const settingsBtn = document.createElement('button');
            settingsBtn.className = 'dock-btn';
            settingsBtn.innerHTML = '‚öôÔ∏è';
            settingsBtn.id = 'btn_settings';
            
            if(isEditMode) {
                 settingsBtn.style.opacity = '0.3';
                 settingsBtn.style.pointerEvents = 'none';
            }

            settingsBtn.onclick = (e) => {
                e.stopPropagation();
                if(isEditMode) return;
                const popup = document.getElementById('settings-popup');
                
                const dockRect = document.getElementById('floating-dock').getBoundingClientRect();
                const isVert = document.getElementById('floating-dock').classList.contains('vertical-mode');
                
                // Smart Position for Settings
                const popupW = 260; // Approximate width
                if (isVert) {
                    let leftPos = dockRect.right + 15;
                    // If going right overflows window, flip to left
                    if (leftPos + popupW > window.innerWidth) {
                        leftPos = dockRect.left - popupW - 15;
                    }
                    popup.style.top = dockRect.top + 'px';
                    popup.style.left = leftPos + 'px';
                } else {
                    popup.style.left = (dockRect.left) + 'px';
                    popup.style.top = (dockRect.top - popup.offsetHeight - 15) + 'px';
                    if (dockRect.top < 300) popup.style.top = (dockRect.bottom + 15) + 'px';
                }
                
                popup.classList.toggle('show');
            };
            container.appendChild(settingsBtn);

            updateDockIndicators();
        }

        /* =========================================
           SMART SNAPPING DOCK DRAG (STRICT BOUNDS)
           ========================================= */
        function initDockDrag() {
            const dock = document.getElementById('floating-dock');
            const handle = document.getElementById('dock-handle');
            
            if(appSettings.dockPos) {
                applyDockState(appSettings.dockPos);
            }

            let isDrag = false;
            let startX, startY, offsetX, offsetY;

            // Handle Click (Toggle Collapse)
            handle.onclick = (e) => {
                if(!isDrag) {
                    dock.classList.toggle('dock-collapsed');
                }
            };

            const onDragStart = (e) => {
                if(e.target.closest('.dock-btn')) return;
                
                // PREVENT TEXT SELECTION HIGHLIGHTING
                if(e.type !== 'touchstart') {
                    e.preventDefault();
                }

                isDrag = false;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                startX = clientX; startY = clientY;
                
                dock.classList.add('is-dragging');
                dock.classList.remove('dock-collapsed'); 
                
                const rect = dock.getBoundingClientRect();
                offsetX = clientX - rect.left;
                offsetY = clientY - rect.top;

                window.addEventListener('mousemove', onDragMove);
                window.addEventListener('mouseup', onDragEnd);
                window.addEventListener('touchmove', onDragMove, {passive:false});
                window.addEventListener('touchend', onDragEnd);
            };

            const onDragMove = (e) => {
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                if (Math.abs(clientX - startX) > 5 || Math.abs(clientY - startY) > 5) {
                    isDrag = true;
                }
                if (!isDrag) return;

                // Calculate Raw Position
                let newX = clientX - offsetX;
                let newY = clientY - offsetY;

                // --- STRICT BOUNDS (During Drag) ---
                const rect = dock.getBoundingClientRect();
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                newX = Math.max(0, Math.min(newX, winW - rect.width));
                newY = Math.max(32, Math.min(newY, winH - rect.height));

                dock.style.left = newX + 'px';
                dock.style.top = newY + 'px';
                dock.style.transform = 'none'; 
            };

            const onDragEnd = (e) => {
                dock.classList.remove('is-dragging');
                window.removeEventListener('mousemove', onDragMove);
                window.removeEventListener('mouseup', onDragEnd);
                window.removeEventListener('touchmove', onDragMove);
                window.removeEventListener('touchend', onDragEnd);

                if(!isDrag) return;

                const rect = dock.getBoundingClientRect();
                const winW = window.innerWidth;
                const winH = window.innerHeight;

                // --- MAGNETIC SNAP LOGIC ---
                const SNAP_THRESHOLD = 15;
                const PADDING = 10;
                
                let finalX = rect.left;
                let finalY = rect.top;
                let orient = appSettings.dockPos.orientation || 'horizontal'; 
                let snapped = false;

                if (Math.abs(winH - rect.bottom) < SNAP_THRESHOLD) {
                    orient = 'horizontal'; finalY = winH - rect.height - PADDING; snapped = true;
                } else if (Math.abs(rect.top - 32) < SNAP_THRESHOLD) {
                    orient = 'horizontal'; finalY = 32 + PADDING; snapped = true;
                } else if (Math.abs(rect.left) < SNAP_THRESHOLD) {
                    orient = 'vertical'; finalX = PADDING; snapped = true;
                } else if (Math.abs(winW - rect.right) < SNAP_THRESHOLD) {
                    orient = 'vertical'; finalX = winW - rect.width - PADDING; snapped = true;
                }

                // --- ROTATION SAFETY CHECK ---
                const currentOrient = dock.classList.contains('vertical-mode') ? 'vertical' : 'horizontal';
                let predWidth = rect.width;
                let predHeight = rect.height;

                if (orient !== currentOrient) {
                    predWidth = rect.height;
                    predHeight = rect.width;
                }

                // --- FINAL BOUNDS CLAMPING ---
                if (finalX < 0) finalX = PADDING;
                if (finalX + predWidth > winW) finalX = winW - predWidth - PADDING;

                if (finalY < 32) finalY = 32 + PADDING;
                if (finalY + predHeight > winH) finalY = winH - predHeight - PADDING;

                if(snapped && orient === 'horizontal') {
                    if(Math.abs((winW/2) - (finalX + predWidth/2)) < 50) {
                        finalX = (winW/2) - (predWidth/2);
                    }
                }

                const newState = { x: finalX + 'px', y: finalY + 'px', orientation: orient };
                
                appSettings.dockPos = newState;
                saveSettings();
                applyDockState(newState);
            };

            handle.addEventListener('mousedown', onDragStart);
            handle.addEventListener('touchstart', onDragStart, {passive:false});
        }

        function applyDockState(pos) {
            const dock = document.getElementById('floating-dock');
            
            dock.className = ''; // reset
            dock.classList.add(pos.orientation + '-mode');
            
            if(!appSettings.dockPinned) {
               dock.classList.add('dock-collapsed');
            } else {
               dock.classList.remove('dock-collapsed');
            }

            dock.style.left = pos.x;
            dock.style.top = pos.y;
            dock.style.transform = 'none';
        }

        /* =========================================
           EDIT MODE
           ========================================= */
        function enableEditMode() {
            isEditMode = true;
            document.getElementById('settings-popup').classList.remove('show');
            document.getElementById('edit-mode-banner').style.display = 'flex';
            document.getElementById('floating-dock').classList.remove('dock-collapsed');
            renderDock(); 
        }

        function disableEditMode() {
            isEditMode = false;
            document.getElementById('edit-mode-banner').style.display = 'none';
            document.querySelectorAll('.edit-popup').forEach(p => p.remove());
            
            if(!appSettings.dockPinned) {
                document.getElementById('floating-dock').classList.add('dock-collapsed');
            }
            renderDock();
        }

        function openEditPopup(e, mod) {
            document.querySelectorAll('.edit-popup').forEach(p => p.remove());
            const popup = document.createElement('div');
            popup.className = 'edit-popup';
            
            const isVert = document.getElementById('floating-dock').classList.contains('vertical-mode');
            const prev = isVert ? '‚Üë' : '‚Üê';
            const next = isVert ? '‚Üì' : '‚Üí';

            popup.innerHTML = `
                <button class="edit-popup-btn" onclick="moveApp('${mod.id}', -1)">${prev}</button>
                <button class="edit-popup-btn" onclick="moveApp('${mod.id}', 1)">${next}</button>
                <div class="edit-popup-sep"></div>
                <button class="edit-popup-btn danger" onclick="confirmRemoveApp('${mod.id}')">üóë</button>
            `;
            
            document.body.appendChild(popup);
            
            const btnRect = e.currentTarget.getBoundingClientRect();
            let top = btnRect.top - 60;
            let left = btnRect.left;

            // Vertical adjustment
            if(top < 40) top = btnRect.bottom + 10;
            
            // Horizontal Safety (Right Edge)
            const popupW = 150; // Approx width
            if (left + popupW > window.innerWidth) {
                left = btnRect.right - popupW;
            }

            popup.style.top = top + 'px';
            popup.style.left = left + 'px';
            
            // Prevent click from immediately closing it
            e.stopPropagation();
        }

        function moveApp(modId, dir) {
            const idx = appSettings.activeModules.indexOf(modId);
            if (idx === -1) return;
            
            const newIdx = idx + dir;
            if (newIdx >= 0 && newIdx < appSettings.activeModules.length) {
                const temp = appSettings.activeModules[idx];
                appSettings.activeModules[idx] = appSettings.activeModules[newIdx];
                appSettings.activeModules[newIdx] = temp;
                saveSettings(); renderDock();
                // Close popup so user sees the move
                document.querySelectorAll('.edit-popup').forEach(p => p.remove());
            }
        }
        
        function confirmRemoveApp(modId) {
            if(confirm('Are you sure you want to remove this app from the dock?')) {
                toggleModuleActive(modId, false);
                document.querySelectorAll('.edit-popup').forEach(p => p.remove());
            }
        }

        /* =========================================
           HELPERS
           ========================================= */
        function toggleWindow(mod) {
            const id = 'win_' + mod.id;
            const el = document.getElementById(id);
            if(el) {
                if(el.style.display === 'none') {
                    el.style.display = 'flex'; el.style.zIndex = ++zIndexCounter;
                    el.classList.remove('minimized');
                } else {
                    el.style.display = 'none'; 
                }
            } else {
                createWindow(mod);
            }
            updateDockIndicators();
        }
        
        function createWindow(mod) {
            const id = 'win_' + mod.id;
            const area = document.getElementById('desktop-area');
            const win = document.createElement('div');
            win.className = 'lyrn-window active';
            win.id = id;
            win.style.zIndex = ++zIndexCounter;
            
            const startW = isTouch ? '90%' : '800px';
            const startH = isTouch ? '80%' : '600px';
            win.style.width = startW; win.style.height = startH;
            
            const offset = (activeWindows.size * 30) + 50;
            win.style.left = isTouch ? '5%' : offset + 'px';
            win.style.top = isTouch ? '10%' : offset + 'px';

            win.innerHTML = `
                <div class="window-header">
                    <span class="window-title">${mod.name}</span>
                    <div class="win-controls">
                         <button class="win-btn" onclick="toggleMaximize(this)">‚òê</button>
                         <button class="win-btn close-btn" onclick="closeWindow('${mod.id}')">‚úï</button>
                    </div>
                </div>
                <div class="window-content">
                    <div class="iframe-shield"></div>
                    <iframe src="modules/${mod.file}"></iframe>
                </div>
                <div class="resize-handle"></div>
            `;
            
            setupWindowDrag(win);
            setupWindowResize(win);
            win.onmousedown = () => { win.style.zIndex = ++zIndexCounter; updateDockIndicators(); };
            win.ontouchstart = () => { win.style.zIndex = ++zIndexCounter; updateDockIndicators(); };
            area.appendChild(win);
            activeWindows.add(mod.id);
            updateDockIndicators();
        }

        function closeWindow(modId) {
            const win = document.getElementById('win_' + modId);
            if(win) win.remove();
            activeWindows.delete(modId);
            updateDockIndicators();
        }

        function setupWindowResize(win) {
            const handle = win.querySelector('.resize-handle');
            const startResize = (e) => {
                e.preventDefault(); e.stopPropagation();
                const startX = e.touches ? e.touches[0].clientX : e.clientX;
                const startY = e.touches ? e.touches[0].clientY : e.clientY;
                const startW = win.offsetWidth; const startH = win.offsetHeight;
                win.classList.add('is-resizing');
                const doResize = (ev) => {
                    const curX = ev.touches ? ev.touches[0].clientX : ev.clientX;
                    const curY = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    const newW = startW + (curX - startX); const newH = startH + (curY - startY);
                    if(newW > 250) win.style.width = newW + 'px';
                    if(newH > 150) win.style.height = newH + 'px';
                };
                const stopResize = () => {
                    win.classList.remove('is-resizing');
                    window.removeEventListener('mousemove', doResize); window.removeEventListener('mouseup', stopResize);
                    window.removeEventListener('touchmove', doResize); window.removeEventListener('touchend', stopResize);
                };
                window.addEventListener('mousemove', doResize); window.addEventListener('mouseup', stopResize);
                window.addEventListener('touchmove', doResize, {passive:false}); window.addEventListener('touchend', stopResize);
            };
            handle.addEventListener('mousedown', startResize); handle.addEventListener('touchstart', startResize, {passive:false});
        }

        function setupWindowDrag(win) {
            const header = win.querySelector('.window-header');
            const startDrag = (e) => {
                if(e.target.closest('button')) return;
                if(win.classList.contains('maximized')) return;
                const startX = e.touches ? e.touches[0].clientX : e.clientX;
                const startY = e.touches ? e.touches[0].clientY : e.clientY;
                const startLeft = win.offsetLeft; const startTop = win.offsetTop;
                win.classList.add('is-dragging');
                const doDrag = (ev) => {
                    ev.preventDefault();
                    const curX = ev.touches ? ev.touches[0].clientX : ev.clientX;
                    const curY = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    win.style.left = (startLeft + (curX - startX)) + 'px';
                    win.style.top = (startTop + (curY - startY)) + 'px';
                };
                const stopDrag = () => {
                    win.classList.remove('is-dragging');
                    window.removeEventListener('mousemove', doDrag); window.removeEventListener('touchmove', doDrag);
                };
                window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', stopDrag);
                window.addEventListener('touchmove', doDrag, {passive:false}); window.addEventListener('touchend', stopDrag);
            };
            header.addEventListener('mousedown', startDrag); header.addEventListener('touchstart', startDrag, {passive:false});
        }

        function updateDockIndicators() {
            document.querySelectorAll('.dock-btn').forEach(btn => btn.classList.remove('is-running'));
            activeWindows.forEach(id => {
                const btn = document.getElementById('btn_' + id);
                if(btn && document.getElementById('win_' + id) && document.getElementById('win_' + id).style.display !== 'none') {
                    btn.classList.add('is-running');
                }
            });
        }

        function resetDock() {
            appSettings.dockPos = { x: '50%', y: '90%', orientation: 'horizontal' };
            appSettings.dockPinned = true;
            document.getElementById('setting-dock-pin').checked = true;
            saveSettings(); applyDockState(appSettings.dockPos);
        }
        function toggleTheme(isDark) { document.body.setAttribute('data-theme', isDark ? 'dark' : 'light'); appSettings.theme = isDark ? 'dark' : 'light'; saveSettings(); }
        
        function toggleDockPin(pinned) { 
            appSettings.dockPinned = pinned; 
            const dock = document.getElementById('floating-dock'); 
            pinned ? dock.classList.remove('dock-collapsed') : dock.classList.add('dock-collapsed'); 
            saveSettings(); 
        }
        
        function toggleModuleActive(modId, active) { if(active) { if(!appSettings.activeModules.includes(modId)) appSettings.activeModules.push(modId); } else { appSettings.activeModules = appSettings.activeModules.filter(m => m !== modId); } saveSettings(); renderDock(); }
        function toggleMaximize(btn) { const win = btn.closest('.lyrn-window'); if(win.classList.contains('maximized')) { win.classList.remove('maximized'); win.style.cssText = win.dataset.cache || ''; } else { win.dataset.cache = win.style.cssText; win.classList.add('maximized'); win.style.top = '32px'; win.style.left = '0'; win.style.width = '100%'; win.style.height = 'calc(100% - 32px)'; } }
        function saveSettings() { localStorage.setItem('lyrn-settings', JSON.stringify(appSettings)); }
        function loadSettings() { const s = localStorage.getItem('lyrn-settings'); if(s) appSettings = { ...appSettings, ...JSON.parse(s) }; if(appSettings.theme) document.body.setAttribute('data-theme', appSettings.theme); }
        
        function startClock() { 
            const timeEl = document.getElementById('sys-clock'); 
            const dateEl = document.getElementById('sys-date');
            
            // Update immediately
            updateTime();
            setInterval(updateTime, 1000);

            function updateTime() {
                const n = new Date();
                if(timeEl) timeEl.innerText = n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                if(dateEl) dateEl.innerText = n.toLocaleDateString([], {month: 'short', day: 'numeric'});
            }
        }
        
        function startCpuMonitor() {
            const el = document.getElementById('sys-cpu');
            if(!el) return;
            // Real CPU usage isn't available in standard JS, so we display Core count + simulated load for visual effect
            const cores = navigator.hardwareConcurrency || 4; 
            
            setInterval(() => {
                const load = Math.floor(Math.random() * 30) + 10; 
                el.innerText = `CORE_${cores} :: ${load}%`;
            }, 2000);
        }

        function initSystemMonitor() { if('getBattery' in navigator) navigator.getBattery().then(b => { const update = () => document.getElementById('sys-battery').innerText = Math.round(b.level*100) + '%'; update(); b.addEventListener('levelchange', update); }); }
        function toggleDashboardFullscreen() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }
        function checkIfIframe() { if(window.self !== window.top) document.getElementById('btn-close-iframe').style.display = 'flex'; }
        function closeDashboard() { window.parent.postMessage({ type: 'CLOSE_DASHBOARD' }, '*'); }
    </script>
</body>
</html>